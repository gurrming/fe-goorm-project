name: CI/CD Pipeline
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 가져오기
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Node.js 설정
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.17.0

      # 3. 패키지 설치
      - name: Install dependencies
        run: npm install

      # 4. .env 파일 생성 (★ 매우 중요: 필요한 모든 변수를 다 적어야 함)
      - name: Create .env file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL_REAL }}" >> .env
          echo "VITE_WEBSOCKET_URL=${{ secrets.VITE_WEBSOCKET_URL_REAL }}" >> .env
        shell: bash

      # 5. 빌드 (이때 .env 내용이 JS 파일로 변환됨)
      - name: Build project
        run: npm run build

      # 6. AWS 자격 증명 설정 (공식 액션 사용 권장)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2 # 본인의 리전으로 수정 (서울: ap-northeast-2, 버지니아: us-east-1)

      # 7. S3 업로드 (AWS CLI 사용)
      - name: Deploy to S3
        run: |
          aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET_NAME }} --delete

      # 8. CloudFront 캐시 무효화 (변경 사항 즉시 반영)
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
